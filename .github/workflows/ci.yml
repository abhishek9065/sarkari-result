name: CI

on:
  workflow_call:
  pull_request:
  push:
    branches:
      - main

jobs:
  backend:
    name: Backend Build + Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint backend
        run: npm run lint

      - name: Build backend
        run: npm run build

      - name: Run backend tests
        run: npm run test:ci

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint frontend
        run: npm run lint

      - name: Build frontend
        run: npm run build

      - name: Enforce frontend bundle budget
        run: npm run check:bundle-size

  admin-frontend-build:
    name: Admin Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: admin-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: admin-frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint admin frontend
        run: npm run lint

      - name: Enforce admin UI guardrails
        run: npm run guard:ui

      - name: Build admin frontend
        run: npm run build

  playwright-smoke:
    name: Playwright Smoke
    runs-on: ubuntu-latest
    needs: frontend-build
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        run: npm run build

      - name: Enforce frontend bundle budget
        run: npm run check:bundle-size

      - name: Run Playwright smoke
        run: npm run test:e2e:ci

      - name: Upload Playwright artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-artifacts
          path: |
            frontend/playwright-report
            frontend/test-results
          if-no-files-found: ignore

  frontend-api-integration:
    name: Frontend API Integration
    runs-on: ubuntu-latest
    needs:
      - backend
      - frontend-build
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Build backend
        run: npm run build
        working-directory: backend

      - name: Start backend
        run: |
          NODE_ENV=integration \
          PORT=5000 \
          MONGODB_URI=mongodb://127.0.0.1:27017/sarkari_db \
          COSMOS_DATABASE_NAME=sarkari_db \
          JWT_SECRET=test-secret \
          node backend/dist/server.js > backend-integration.log 2>&1 &

      - name: Wait for backend health
        run: |
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:5000/api/health > /dev/null; then
              echo "Backend is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Backend did not become healthy in time"
          exit 1

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium
        working-directory: frontend

      - name: Run frontend API integration gate
        run: npm run test:e2e:api:integration
        working-directory: frontend
        env:
          VITE_PROXY_TARGET: http://127.0.0.1:5000

      - name: Upload frontend API integration artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-api-integration-artifacts
          path: |
            backend-integration.log
            frontend/playwright-report
            frontend/test-results
          if-no-files-found: ignore
  admin-playwright-smoke:
    name: Admin Playwright Smoke
    runs-on: ubuntu-latest
    needs: admin-frontend-build
    defaults:
      run:
        working-directory: admin-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: admin-frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run admin Playwright smoke
        run: npm run test:e2e:ci
        env:
          VITE_ADMIN_BASENAME: /admin
          VITE_ADMIN_E2E_STEPUP_BYPASS: 'true'

      - name: Upload admin Playwright artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: admin-playwright-smoke-artifacts
          path: |
            admin-frontend/playwright-report
            admin-frontend/test-results
          if-no-files-found: ignore

  admin-api-integration:
    name: Admin API Integration
    runs-on: ubuntu-latest
    needs:
      - backend
      - admin-frontend-build
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            admin-frontend/package-lock.json

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Build backend
        run: npm run build
        working-directory: backend

      - name: Start backend
        run: |
          NODE_ENV=integration \
          PORT=5000 \
          MONGODB_URI=mongodb://127.0.0.1:27017/sarkari_db \
          COSMOS_DATABASE_NAME=sarkari_db \
          JWT_SECRET=test-secret \
          ADMIN_SETUP_KEY=setup-admin-123 \
          TOTP_ENCRYPTION_KEY=test-totp-key \
          ADMIN_BACKUP_CODE_SALT=test-backup-salt \
          ADMIN_EMAIL_ALLOWLIST=admin.integration@sarkariexams.me \
          ADMIN_ENFORCE_HTTPS=false \
          ADMIN_REQUIRE_2FA=false \
          ADMIN_DUAL_APPROVAL_REQUIRED=false \
          node backend/dist/server.js > backend-admin-integration.log 2>&1 &

      - name: Wait for backend health
        run: |
          for i in {1..40}; do
            if curl -fsS http://127.0.0.1:5000/api/health > /dev/null; then
              echo "Backend is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Backend did not become healthy in time"
          exit 1

      - name: Install admin frontend dependencies
        run: npm ci
        working-directory: admin-frontend

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium
        working-directory: admin-frontend

      - name: Run admin API integration gate
        run: npm run test:e2e:integration
        working-directory: admin-frontend
        env:
          VITE_PROXY_TARGET: http://127.0.0.1:5000
          VITE_ADMIN_BASENAME: /admin
          VITE_ADMIN_E2E_STEPUP_BYPASS: 'false'
          ADMIN_E2E_EMAIL: admin.integration@sarkariexams.me
          ADMIN_E2E_PASSWORD: Password#12345
          ADMIN_E2E_SETUP_KEY: setup-admin-123

      - name: Upload admin API integration artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: admin-api-integration-artifacts
          path: |
            backend-admin-integration.log
            admin-frontend/playwright-report
            admin-frontend/test-results
          if-no-files-found: ignore





