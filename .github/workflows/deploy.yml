name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger from GitHub UI

# Prevent concurrent deployments
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # Run CI checks first
  ci-gate:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: ci-gate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            cd ~/sarkari-result

            echo "=== Pulling latest code ==="
            git pull --ff-only origin main

            echo "=== Building and restarting containers ==="
            docker compose --env-file .env up -d --build nginx backend frontend admin-frontend

            echo "=== Waiting for backend health ==="
            for i in $(seq 1 30); do
              if docker compose exec -T backend wget -qO- http://127.0.0.1:4000/api/health >/dev/null 2>&1; then
                echo "Backend healthy after $i attempts"
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "ERROR: Backend did not become healthy"
                docker compose logs --tail=60 backend
                exit 1
              fi
              sleep 2
            done

            echo "=== Container status ==="
            docker compose ps

      - name: Purge Cloudflare Cache
        if: success()
        run: |
          if [ -n "${{ secrets.CF_ZONE_ID }}" ] && [ -n "${{ secrets.CF_API_TOKEN }}" ]; then
            echo "Purging Cloudflare cache..."
            resp=$(curl -sS -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}')
            
            if echo "$resp" | grep -q '"success":true'; then
              echo "Cloudflare cache purged successfully"
            else
              echo "WARNING: Cloudflare cache purge response:"
              echo "$resp"
            fi
          else
            echo "NOTICE: CF_ZONE_ID or CF_API_TOKEN secrets not configured — skipping cache purge"
          fi

      - name: Verify Production Health
        if: success()
        run: |
          echo "Checking production endpoints..."
          for url in \
            "https://sarkariexams.me/api/health" \
            "https://sarkariexams.me/" \
            "https://sarkariexams.me/admin"; do
            status=$(curl -k -sS -o /dev/null -w "%{http_code}" "$url" || true)
            if [[ "$status" =~ ^(2|3) ]]; then
              echo "✓ $url (status=$status)"
            else
              echo "✗ $url (status=$status)"
            fi
          done
