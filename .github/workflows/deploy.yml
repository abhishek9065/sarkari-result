name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
    environment: production
    steps:
      - name: Check deploy configuration
        id: deploy-config
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
          DO_SSH_KEY: ${{ secrets.DO_SSH_KEY }}
        run: |
          missing=0
          for key in DO_HOST DO_USER DO_SSH_KEY; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Deployment is skipped because required DigitalOcean secrets are not configured."
            exit 0
          fi

          echo "enabled=true" >> "$GITHUB_OUTPUT"

      - name: Deploy via SSH
        if: steps.deploy-config.outputs.enabled == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            set -euo pipefail
            cd ~/sarkari-result

            echo "=== Pulling latest code ==="
            git pull --ff-only origin main

            echo "=== Running guarded production deploy ==="
            bash scripts/deploy-prod.sh

      - name: Purge Cloudflare Cache
        if: steps.deploy-config.outputs.enabled == 'true' && success()
        run: |
          if [ -n "${{ secrets.CF_ZONE_ID }}" ] && [ -n "${{ secrets.CF_API_TOKEN }}" ]; then
            echo "Purging Cloudflare cache..."
            resp=$(curl -sS -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}')

            if echo "$resp" | grep -q '"success":true'; then
              echo "Cloudflare cache purged successfully"
            else
              echo "WARNING: Cloudflare cache purge response:"
              echo "$resp"
            fi
          else
            echo "NOTICE: CF_ZONE_ID or CF_API_TOKEN secrets not configured - skipping cache purge"
          fi

      - name: Verify Production Health
        if: steps.deploy-config.outputs.enabled == 'true' && success()
        run: |
          echo "Checking production endpoints..."
          for url in \
            "https://sarkariexams.me/api/health" \
            "https://sarkariexams.me/" \
            "https://sarkariexams.me/admin"; do
            status=$(curl -k -sS -o /dev/null -w "%{http_code}" "$url" || true)
            if [[ "$status" =~ ^(2|3) ]]; then
              echo "OK $url (status=$status)"
            else
              echo "FAIL $url (status=$status)"
            fi
          done
