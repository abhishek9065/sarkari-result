name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  ci-gate:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: ci-gate
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
    environment: production
    steps:
      - name: Check deploy configuration
        id: deploy-config
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
          DO_SSH_KEY: ${{ secrets.DO_SSH_KEY }}
        run: |
          missing=0
          for key in DO_HOST DO_USER DO_SSH_KEY; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Deployment is skipped because required DigitalOcean secrets are not configured."
            exit 0
          fi

          echo "enabled=true" >> "$GITHUB_OUTPUT"

      - name: Deploy via SSH
        if: steps.deploy-config.outputs.enabled == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            set -euo pipefail
            cd ~/sarkari-result

            echo "=== Pulling latest code ==="
            git pull --ff-only origin main

            echo "=== Building and restarting containers ==="
            docker compose --env-file .env up -d --build nginx backend frontend admin-frontend

            echo "=== Waiting for backend health ==="
            for i in $(seq 1 30); do
              if docker compose exec -T backend wget -qO- http://127.0.0.1:4000/api/health >/dev/null 2>&1; then
                echo "Backend healthy after $i attempts"
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "ERROR: Backend did not become healthy"
                docker compose logs --tail=60 backend
                exit 1
              fi
              sleep 2
            done

            echo "=== Container status ==="
            docker compose ps

      - name: Purge Cloudflare Cache
        if: steps.deploy-config.outputs.enabled == 'true' && success()
        run: |
          if [ -n "${{ secrets.CF_ZONE_ID }}" ] && [ -n "${{ secrets.CF_API_TOKEN }}" ]; then
            echo "Purging Cloudflare cache..."
            resp=$(curl -sS -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}')

            if echo "$resp" | grep -q '"success":true'; then
              echo "Cloudflare cache purged successfully"
            else
              echo "WARNING: Cloudflare cache purge response:"
              echo "$resp"
            fi
          else
            echo "NOTICE: CF_ZONE_ID or CF_API_TOKEN secrets not configured - skipping cache purge"
          fi

      - name: Verify Production Health
        if: steps.deploy-config.outputs.enabled == 'true' && success()
        run: |
          echo "Checking production endpoints..."
          for url in \
            "https://sarkariexams.me/api/health" \
            "https://sarkariexams.me/" \
            "https://sarkariexams.me/admin"; do
            status=$(curl -k -sS -o /dev/null -w "%{http_code}" "$url" || true)
            if [[ "$status" =~ ^(2|3) ]]; then
              echo "OK $url (status=$status)"
            else
              echo "FAIL $url (status=$status)"
            fi
          done
