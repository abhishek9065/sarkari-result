services:
  # Nginx Reverse Proxy with SSL
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: sarkari-nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - admin-frontend
      - backend
    restart: unless-stopped
    networks:
      - sarkari-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:80" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sarkari-backend
    environment:
      - NODE_ENV=production
      - PORT=4000
      - COSMOS_CONNECTION_STRING=${COSMOS_CONNECTION_STRING}
      - COSMOS_DATABASE_NAME=${COSMOS_DATABASE_NAME:-sarkari_db}
      - JWT_SECRET=${JWT_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}
      - SENTRY_DSN=${SENTRY_DSN}
      - FRONTEND_URL=${FRONTEND_URL:-https://sarkariexams.me}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://sarkariexams.me,https://www.sarkariexams.me}
      - ADMIN_SETUP_KEY=${ADMIN_SETUP_KEY}
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY}
      - ADMIN_EMAIL_ALLOWLIST=${ADMIN_EMAIL_ALLOWLIST}
      - ADMIN_DOMAIN_ALLOWLIST=${ADMIN_DOMAIN_ALLOWLIST}
      - ADMIN_REQUIRE_2FA=${ADMIN_REQUIRE_2FA:-true}
      - ADMIN_ENFORCE_HTTPS=${ADMIN_ENFORCE_HTTPS:-true}
    expose:
      - "4000"
    restart: unless-stopped
    networks:
      - sarkari-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:4000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sarkari-frontend
    expose:
      - "80"
    restart: unless-stopped
    networks:
      - sarkari-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:80" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Admin Frontend (vNext)
  admin-frontend:
    build:
      context: ./admin-frontend
      dockerfile: Dockerfile
    container_name: sarkari-admin-frontend
    expose:
      - "80"
    restart: unless-stopped
    networks:
      - sarkari-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:80" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Datadog Agent for Infrastructure Monitoring
  datadog-agent:
    image: gcr.io/datadoghq/agent:latest
    container_name: sarkari-datadog
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.com}
      - DD_HOSTNAME=sarkariexams-server
      - DD_TAGS=env:production,service:sarkari-result
      # Docker monitoring
      - DD_DOCKER_LABELS_AS_TAGS=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      # APM for tracing
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      # Process monitoring
      - DD_PROCESS_AGENT_ENABLED=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - sarkari-network
    restart: unless-stopped

networks:
  sarkari-network:
    driver: bridge

volumes:
  nginx-logs:
